/*! backshift 1.3.3 - built on 2023-05-30 */

Function.prototype.bind||(Function.prototype.bind=function(oThis){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");function fNOP(){}function fBound(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this;return fNOP.prototype=this.prototype,fBound.prototype=new fNOP,fBound});var Backshift=Backshift||{};Backshift.namespace=function(ns_string){var i,parts=ns_string.split("."),parent=Backshift;for("Backshift"===parts[0]&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)void 0===parent[parts[i]]&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent},Backshift.keys=function(obj){var key,keys=[];for(key in obj)obj.hasOwnProperty(key)&&keys.push(key);return keys},Backshift.extend=function(destination,source){for(var property in source)source.hasOwnProperty(property)&&(destination[property]=source[property]);return destination},Backshift.rows=function(matrix){var ncols=matrix.length;if(0===ncols)return[];for(var nrows=matrix[0].length,rows=new Array(nrows),i=0;i<nrows;i++){for(var row=new Array(ncols),j=0;j<ncols;j++)row[j]=matrix[j][i];rows[i]=row}return rows},Backshift.fail=function(msg){throw console.log("Error: "+msg),"Error: "+msg},Backshift.clone=function(obj){return JSON.parse(JSON.stringify(obj))},function(globalContext){var _toString=Object.prototype.toString,FUNCTION_CLASS="[object Function]";function isFunction(object){return _toString.call(object)===FUNCTION_CLASS}var slice=Array.prototype.slice;function update(array,args){for(var arrayLength=array.length,length=args.length;length--;)array[arrayLength+length]=args[length];return array}function bind(fn,context){if(arguments.length<2&&void 0===fn)return this;var __method=fn,args=slice.call(arguments,2);return function(){var a=function(array,args){return update(array=slice.call(array,0),args)}(args,arguments);return __method.apply(context,a)}}function emptyFunction(){}var IS_DONTENUM_BUGGY,Class=(IS_DONTENUM_BUGGY=function(){for(var p in{toString:1})if("toString"===p)return!1;return!0}(),{create:function(){var parent=null,properties=[].slice.apply(arguments);function klass(){this.initialize.apply(this,arguments)}if(isFunction(properties[0])&&(parent=properties.shift()),function(destination,source){for(var property in source)source.hasOwnProperty(property)&&(destination[property]=source[property])}(klass,Class.Methods),klass.superclass=parent,klass.subclasses=[],parent){subclass.prototype=parent.prototype,klass.prototype=new subclass;try{parent.subclasses.push(klass)}catch(e){}}for(var i=0,length=properties.length;i<length;i++)klass.addMethods(properties[i]);return klass.prototype.initialize||(klass.prototype.initialize=emptyFunction),klass.prototype.constructor=klass},Methods:{addMethods:function(source){var ancestor=this.superclass&&this.superclass.prototype,properties=function(object){var property,results=[];for(property in object)object.hasOwnProperty(property)&&results.push(property);return results}(source);IS_DONTENUM_BUGGY&&(source.toString!=Object.prototype.toString&&properties.push("toString"),source.valueOf!=Object.prototype.valueOf&&properties.push("valueOf"));for(var i=0,length=properties.length;i<length;i++){var method,property=properties[i],value=source[property];ancestor&&isFunction(value)&&"$super"==(1!=(method=(method=value).toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",")).length||method[0]?method:[])[0]&&((value=function(fn,wrapper){var __method=fn;return function(){var a=update([bind(__method,this)],arguments);return wrapper.apply(this,a)}}(function(m){return function(){return ancestor[m].apply(this,arguments)}}(property),method=value)).valueOf=bind(method.valueOf,method),value.toString=bind(method.toString,method)),this.prototype[property]=value}return this}}});function subclass(){}globalContext.exports?globalContext.exports.Class=Class:globalContext.Class=Class}(Backshift),Backshift.namespace("Backshift.Class.Configurable"),Backshift.Class.Configurable=Backshift.Class.create({configure:function(args){args=args||{},Backshift.keys(this.defaults()).forEach(function(key){args.hasOwnProperty(key)?null!==this.defaults()[key]&&"object"==typeof this.defaults()[key]?Backshift.keys(this.defaults()[key]).forEach(function(k){this[key][k]=(void 0!==args[key][k]?args:void 0!==this[key][k]?this:this.defaults())[key][k]},this):this[key]=(void 0!==args[key]?args:void 0!==this[key]?this:this.defaults())[key]:this[key]=this[key]||this.defaults()[key]},this)}}),Backshift.namespace("Backshift.Math"),Backshift.Math={},Backshift.Math.lcm=function(A){if(void 0===A||A.length<1)return 0;for(var n=A.length,a=Math.abs(A[0]),i=1;i<n;i++){for(var b=Math.abs(A[i]),c=a;a&&b;)b<a?a%=b:b%=a;a=Math.abs(c*A[i])/(a+b)}return a},Backshift.namespace("Backshift.Stats"),Backshift.Stats={},Backshift.Stats.Maximum=function(array){for(var max=NaN,k=array.length;k--;)isNaN(array[k])||(isNaN(max)||array[k]>max)&&(max=array[k]);return max},Backshift.Stats.Minimum=function(array){for(var min=NaN,k=array.length;k--;)isNaN(array[k])||(isNaN(min)||array[k]<min)&&(min=array[k]);return min},Backshift.Stats.Average=function(array){if(0===array.length)return NaN;for(var sum=0,n=0,k=array.length;k--;)isNaN(array[k])||(sum+=array[k],n++);return n<1?NaN:sum/n},Backshift.Stats.StdDev=function(array){if(array.length<2)return NaN;for(var v,d,m=0,m2=0,len=array.length,i=0;i<len;++i)isNaN(array[i])||(m2+=(d=(v=array[i])-m)*(v-(m+=d/(i+1))));return Math.sqrt(m2/(len-1))},Backshift.Stats.Last=function(array){for(var k=array.length;k--;)if(!isNaN(array[k]))return array[k];return NaN},Backshift.Stats.First=function(array){for(var n=array.length,k=0;k<n;k++)if(!isNaN(array[k]))return array[k];return NaN},Backshift.Stats.Total=function(array){if(0===array.length)return NaN;for(var sum=0,k=array.length;k--;)isNaN(array[k])||(sum+=array[k]);return sum},Backshift.Stats.Map={max:Backshift.Stats.Maximum,min:Backshift.Stats.Minimum,avg:Backshift.Stats.Average,stdev:Backshift.Stats.StdDev,last:Backshift.Stats.Last,first:Backshift.Stats.First,total:Backshift.Stats.Total},Backshift.namespace("Backshift.Utilities.Url"),Backshift.Utilities.Url=Backshift.Class.create({initialize:function(baseUrl){this.url=baseUrl,this.paramCount=0},andParam:function(kw,parameter){var sep=0<this.paramCount?"&":"?";return void 0!==parameter&&(this.paramCount+=1,this.url=this.url+sep+kw+"="+parameter),this},toString:function(){return this.url}}),Backshift.namespace("Backshift.Utilities.RpnToJexlConverter"),Backshift.Utilities.RpnToJexlConverter=Backshift.Class.create({initialize:function(){this.operators={},this._buildOperators()},_buildOperators:function(){function simpleOp(op){return function(stack){var b=stack.pop();return"("+stack.pop()+" "+op+" "+b+")"}}function funcOp(op,numArgs){return function(stack){for(var ret=op+"(",i=0;i<numArgs;i++)ret+=stack.pop()+",";return ret.substring(0,ret.length-1)+")"}}function booleanOp(op){return function(stack){var b=stack.pop();return"("+stack.pop()+" "+op+" "+b+" ? 1 : 0)"}}function minMaxNanOp(op){return function(a){var b=a.pop(),a=a.pop();return"( ( "+a+" == NaN ) ? "+b+" : ( ( "+b+" == NaN ) ? "+a+" : ( "+op+"("+b+","+a+") ) ) )"}}var op,numArgs;this.operators["+"]=simpleOp("+"),this.operators["-"]=simpleOp("-"),this.operators["*"]=simpleOp("*"),this.operators["/"]=simpleOp("/"),this.operators["%"]=simpleOp("%"),this.operators.IF=function(stack){var c=stack.pop(),b=stack.pop();return"("+stack.pop()+" != 0 ? "+b+" : "+c+")"},this.operators.UN=function(stack){return"( ("+stack.pop()+" == NaN) ? 1 : 0)"},this.operators.LT=booleanOp("<"),this.operators.LE=booleanOp("<="),this.operators.GT=booleanOp(">"),this.operators.GE=booleanOp(">="),this.operators.EQ=booleanOp("=="),this.operators.NE=booleanOp("!="),this.operators.MIN=funcOp("math:min",2),this.operators.MAX=funcOp("math:max",2),this.operators.MINNAN=minMaxNanOp("math:min"),this.operators.MAXNAN=minMaxNanOp("math:max"),this.operators.ISINF=function(a){a=a.pop();return"( ("+a+" == __inf) || ("+a+" == __neg_inf) ? 1 : 0)"},this.operators.LIMIT=function(val){var max=val.pop(),min=val.pop(),val=val.pop();return"( ( ("+min+" == __inf) || ("+min+" == __neg_inf) || ("+max+" == __inf) || ("+max+" == __neg_inf) || ("+val+" == __inf) || ("+val+" == __neg_inf) || ("+val+" < "+min+") || ("+val+" > "+max+") ) ? NaN : "+val+" )"},this.operators.ADDNAN=function(a){var b=a.pop(),a=a.pop();return"( ( ( "+a+" == NaN ) && ( "+b+" == NaN ) ) ? NaN : ( ( "+a+" == NaN ) ? "+b+" : ( ( "+b+" == NaN ) ? "+a+" : ( "+a+" + "+b+" ) ) ) )"},this.operators.POW=(op="math:pow",numArgs=2,function(stack){for(var ret=")",i=0;i<numArgs;i++)ret=","+stack.pop()+ret;return op+"("+ret.substring(1,ret.length)}),this.operators.SIN=funcOp("math:sin",1),this.operators.COS=funcOp("math:cos",1),this.operators.LOG=funcOp("math:log",1),this.operators.EXP=funcOp("math:exp",1),this.operators.SQRT=funcOp("math:sqrt",1),this.operators.ATAN=funcOp("math:atan",1),this.operators.ATAN2=function(stack){var x=stack.pop();return"math:atan2("+stack.pop()+","+x+")"},this.operators.FLOOR=funcOp("math:floor",1),this.operators.CEIL=funcOp("math:ceil",1),this.operators.RAD2DEG=funcOp("math:toDegrees",1),this.operators.DEG2RAD=funcOp("math:toRadians",1),this.operators.ABS=funcOp("math:abs",1),this.operators.UNKN=function(){return"NaN"},this.operators.INF=function(){return"__inf"},this.operators.NEGINF=function(){return"__neg_inf"},this.operators["{diffTime}"]=function(){return"(__diff_time / 1000)"}},convert:function(rpn){for(var token,stack=[],tokens=rpn.split(","),n=tokens.length,i=0;i<n;i++)token=tokens[i],this._isOperator(token)?stack.push(this._toExpression(token,stack)):stack.push(token);if(1===stack.length)return stack.pop();Backshift.fail("Too many input values in RPN express. RPN: "+rpn+" Stack: "+JSON.stringify(stack))},_isOperator:function(token){return token in this.operators},_toExpression:function(token,stack){return this.operators[token](stack)}}),Backshift.namespace("Backshift.Utilities.RpnEvaluator"),Backshift.Utilities.RpnEvaluator=Backshift.Class.create({initialize:function(){this.operators={},this._buildOperators()},_valueOf:function(token,context){return token in context&&context.hasOwnProperty(token)?context[token]:parseFloat(token)},_buildOperators:function(){function funcOp(op,numArgs){return function(stack,context){for(var values=new Array(numArgs),i=0;i<numArgs;i++)values[i]=self._valueOf(stack.pop(),context);return values.reverse(),op.apply(null,values)}}var self=this;this.operators["+"]=funcOp(function(a,b){return a+b},2),this.operators["-"]=funcOp(function(a,b){return a-b},2),this.operators["*"]=funcOp(function(a,b){return a*b},2),this.operators["/"]=funcOp(function(a,b){return a/b},2),this.operators["%"]=funcOp(function(a,b){return a%b},2),this.operators.IF=funcOp(function(a,b,c){return 0!=a?b:c},3),this.operators.UN=funcOp(function(a){return isNaN(a)?0:1},1),this.operators.LT=funcOp(function(a,b){return a<b?1:0},2),this.operators.LE=funcOp(function(a,b){return a<=b?1:0},2),this.operators.GT=funcOp(function(a,b){return b<a?1:0},2),this.operators.GE=funcOp(function(a,b){return b<=a?1:0},2),this.operators.EQ=funcOp(function(a,b){return a==b?1:0},2),this.operators.NE=funcOp(function(a,b){return a!=b?1:0},2),this.operators.MIN=funcOp(function(a,b){return Math.min(a,b)},2),this.operators.MAX=funcOp(function(a,b){return Math.max(a,b)},2),this.operators.MINNAN=funcOp(function(a,b){return isNaN(a)?b:isNaN(b)?a:Math.min(a,b)},2),this.operators.MAXNAN=funcOp(function(a,b){return isNaN(a)?b:isNaN(b)?a:Math.max(a,b)},2),this.operators.ISINF=funcOp(function(a){return a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY?1:0},1),this.operators.LIMIT=function(stack,val){var max=self._valueOf(stack.pop(),val),min=self._valueOf(stack.pop(),val),val=self._valueOf(stack.pop(),val);return val===Number.POSITIVE_INFINITY||val===Number.NEGATIVE_INFINITY||min==Number.POSITIVE_INFINITY||min===Number.NEGATIVE_INFINITY||max==Number.POSITIVE_INFINITY||max===Number.NEGATIVE_INFINITY||val<min||max<val?NaN:val},this.operators.ADDNAN=function(stack,a){var b=self._valueOf(stack.pop(),a),a=self._valueOf(stack.pop(),a);return isNaN(a)&&isNaN(b)?NaN:isNaN(a)?b:isNaN(b)?a:a+b},this.operators.POW=funcOp(function(a,b){return Math.pow(a,b)},2),this.operators.SIN=funcOp(function(a){return Math.sin(a)},1),this.operators.COS=funcOp(function(a){return Math.cos(a)},1),this.operators.LOG=funcOp(function(a){return Math.log(a)},1),this.operators.EXP=funcOp(function(a){return Math.exp(a)},1),this.operators.SQRT=funcOp(function(a){return Math.sqrt(a)},1),this.operators.ATAN=funcOp(function(a){return Math.atan(a)},1),this.operators.ATAN2=funcOp(function(a,b){return Math.atan(a,b)},2),this.operators.FLOOR=funcOp(function(a){return Math.floor(a)},1),this.operators.CEIL=funcOp(function(a){return Math.ceil(a)},1),this.operators.RAD2DEG=funcOp(function(a){return a*(180/Math.PI)},1),this.operators.DEG2RAD=funcOp(function(a){return a*(Math.PI/180)},1),this.operators.ABS=funcOp(function(a){return Math.abs(a)},1),this.operators.UNKN=funcOp(function(){return NaN},0),this.operators.INF=funcOp(function(){return Number.POSITIVE_INFINITY},0),this.operators.NEGINF=funcOp(function(){return Number.NEGATIVE_INFINITY},0)},evaluate:function(rpn,context){for(var token,stack=[],tokens=rpn.split(","),n=tokens.length,i=0;i<n;i++)token=tokens[i],this._isOperator(token)?stack.push(this._eval(token,stack,context)):stack.push(token);if(1===stack.length)return stack.pop();Backshift.fail("Too many input values in RPN express. RPN: "+rpn+" Stack: "+JSON.stringify(stack))},_isOperator:function(token){return token in this.operators},_eval:function(token,stack,context){return this.operators[token](stack,context)}}),Backshift.namespace("Backshift.Utilities.Consolidator"),Backshift.Utilities.Consolidator=Backshift.Class.create(function(){var functions={},clazz={initialize:function(){},parse:function(argument){var metricName=(argument="string"==typeof argument?argument.split(","):argument).shift(),functionName=argument.pop().toLowerCase();functionName in functions||Backshift.fail("Unknown correlation function: "+functionName),1<argument.length&&Backshift.fail("Too many input values in RPN express. RPN: "+argument);argument=parseFloat(argument[0]);return functions[functionName](metricName,argument)}};function valid(value){return!isNaN(value)&&isFinite(value)}function forEach(timestamps,values,cb){for(var validCount=0,i=0;i<timestamps.length;i++)valid(values[i])&&(validCount++,cb(timestamps[i],values[i]));return validCount}function wrap(func){return function(metricName,argument){return{metricName:metricName,functionName:func.name,argument:argument,consolidate:function(data){return func(data.columns[data.columnNameToIndex.timestamp],data.columns[data.columnNameToIndex[metricName]],argument)}}}}return clazz.minimum=functions.minimum=wrap(function(timestamps,values){var minimumTimestamp=void 0,minimumValue=NaN;return forEach(timestamps,values,function(timestamp,value){(isNaN(minimumValue)||value<minimumValue)&&(minimumTimestamp=timestamp,minimumValue=value)}),[minimumTimestamp,minimumValue]}),clazz.maximum=functions.maximum=wrap(function(timestamps,values){var maximumTimestamp=void 0,maximumValue=NaN;return forEach(timestamps,values,function(timestamp,value){(isNaN(maximumValue)||maximumValue<value)&&(maximumTimestamp=timestamp,maximumValue=value)}),[maximumTimestamp,maximumValue]}),clazz.average=functions.average=wrap(function(timestamps,cnt){var sum=0,cnt=forEach(timestamps,cnt,function(timestamp,value){sum+=value});return[void 0,sum/cnt]}),clazz.stdev=functions.stdev=wrap(function(timestamps,values){var sum=0,cnt=forEach(timestamps,values,function(timestamp,value){sum+=value}),avg=sum/cnt,dev=0;return forEach(timestamps,values,function(timestamp,value){dev+=Math.pow(value-avg,2)}),[void 0,Math.sqrt(dev/cnt)]}),clazz.last=functions.last=wrap(function(timestamps,values){for(var i=timestamps.length-1;0<=i;i--)if(valid(values[i]))return[timestamps[i],values[i]];return[void 0,NaN]}),clazz.first=functions.first=wrap(function(timestamps,values){for(var i=0;i<timestamps.length;i++)if(valid(values[i]))return[timestamps[i],values[i]];return[void 0,NaN]}),clazz.total=functions.total=wrap(function(timestamps,values){for(var sum=0,cnt=0,i=1;i<timestamps.length;i++)valid(values[i])&&(sum+=values[i]*(timestamps[i]-timestamps[i-1])/1e3,cnt+=1);return 0<cnt?[void 0,sum]:[void 0,NaN]}),clazz.percent=functions.percent=wrap(function(timestamps,values,argument){for(var sortedValues=Array(),i=0;i<timestamps.length;i++)sortedValues.push(values[i]);return sortedValues.sort(function(a,b){return isNaN(a)||!isNaN(b)&&a!=Number.POSITIVE_INFINITY&&(a==Number.NEGATIVE_INFINITY||b==Number.POSITIVE_INFINITY||b!=Number.NEGATIVE_INFINITY&&a<b)?-1:1}),[void 0,sortedValues[Math.round(argument*(sortedValues.length-1)/100)]]}),clazz.percentnan=functions.percentnan=wrap(function(timestamps,values,argument){var sortedValues=Array();return forEach(timestamps,values,function(timestamp,value){sortedValues.push(value)}),sortedValues.sort(),[void 0,sortedValues[Math.round(argument*(sortedValues.length-1)/100)]]}),functions.min=functions.minimum,functions.max=functions.maximum,clazz}()),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphVisitor=Backshift.Class.create({initialize:function(args){this.onInit(args)},onInit:function(args){},_visit:function(graphDef){for(var args,command,name,path,dsName,rpnExpression,subParts,width,srcName,color,legend,aggregation,value,parts={parse:function(str,lookForQuotes){for(var args=[],readingPart=!1,part="",n=str.length,i=0;i<n;i++)" "!==str.charAt(i)||readingPart?('"'===str.charAt(i)&&lookForQuotes&&(readingPart=!readingPart),part+=str.charAt(i)):(args.push(part),part="");return args.push(part),args}}.parse(graphDef.command,!0),n=parts.length,i=0;i<n;i++){if(0===parts[i].indexOf("--")){if(null===(args=/--(.*)=(.*)/.exec(parts[i])))continue;"title"===args[1]?this._onTitle(this.displayString(this._decodeString(args[2]))):"vertical-label"===args[1]&&this._onVerticalLabel(this.displayString(this._decodeString(args[2])))}null!==(args=parts[i].match(/(\\.|[^:])+/g))&&("DEF"===(command=args[0])?(name=(subParts=args[1].split("="))[0],path=subParts[1],dsName=args[2],width=args[3],this._onDEF(name,path,dsName,width)):"CDEF"===command?(name=(subParts=args[1].split("="))[0],rpnExpression=subParts[1],this._onCDEF(name,rpnExpression)):"VDEF"===command?(name=(subParts=args[1].split("="))[0],rpnExpression=subParts[1],this._onVDEF(name,rpnExpression)):command.match(/LINE/)?(width=parseInt(/LINE(\d+)/.exec(command)),srcName=(subParts=args[1].split("#"))[0],color=this._getColor(subParts[1]),legend=this._decodeString(args[2]),this._onLine(srcName,color,legend,width)):"AREA"===command?(srcName=(subParts=args[1].split("#"))[0],color=this._getColor(subParts[1]),legend=this._decodeString(args[2]),this._onArea(srcName,color,legend)):"STACK"===command?(srcName=(subParts=args[1].split("#"))[0],color=this._getColor(subParts[1]),legend=this._decodeString(args[2]),this._onStack(srcName,color,legend)):"GPRINT"===command?(value=3===args.length?(srcName=args[1],aggregation=void 0,this._decodeString(args[2])):(srcName=args[1],aggregation=args[2],this._decodeString(args[3])),this._onGPrint(srcName,aggregation,value)):"COMMENT"===command&&(value=this._decodeString(args[1]),this._onComment(value)))}},_getColor:function(color){if(void 0!==color&&""!==color)return"#"+color},_onTitle:function(title){},_onVerticalLabel:function(label){},_onDEF:function(name,path,dsName,consolFun){},_onCDEF:function(name,rpnExpression){},_onVDEF:function(name,rpnExpression){},_onLine:function(srcName,color,legend,width){},_onArea:function(srcName,color,legend){},_onStack:function(srcName,color,legend){},_onGPrint:function(srcName,aggregation,value){},_onComment:function(value){},_seriesName:function(string){},_decodeString:function(string){return void 0===string?string:string=(string=string.replace(/"/g,"")).replace("\\:",":")},displayString:function(string){return void 0===string?string:string=(string=string.replace("\\n","")).trim()}}),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphConverter=Backshift.Class.create(Backshift.Utilities.RrdGraphVisitor,{onInit:function(args){var propertyValue;for(this.graphDef=args.graphDef,this.resourceId=args.resourceId,this.convertRpnToJexl=void 0===args.convertRpnToJexl||args.convertRpnToJexl,this.model={metrics:[],values:[],series:[],printStatements:[],properties:{}},this.rpnConverter=new Backshift.Utilities.RpnToJexlConverter,this.consolidator=new Backshift.Utilities.Consolidator,i=0,n=this.graphDef.propertiesValues.length;i<n;i++)propertyValue=this.graphDef.propertiesValues[i],this.model.properties[propertyValue]=void 0;for(this._visit(this.graphDef),i=0,n=this.model.values.length;i<n;i++){var metric=this.model.values[i].expression.metricName;if(void 0!==metric){for(var foundSeries=!1,j=0,m=this.model.series.length;j<m;j++)if(metric===this.model.series[j].metric){foundSeries=!0;break}foundSeries||this.model.series.push({metric:metric,type:"hidden"})}}for(var nonTransientMetrics={},i=0,n=this.model.series.length;i<n;i++)nonTransientMetrics[this.model.series[i].metric]=1;for(i=0,n=this.model.metrics.length;i<n;i++)(metric=this.model.metrics[i]).transient=!(metric.name in nonTransientMetrics)},_onTitle:function(title){this.model.title=title},_onVerticalLabel:function(label){this.model.verticalLabel=label},_onDEF:function(name,attribute,dsName,consolFun){attribute=parseInt(/\{rrd(\d+)}/.exec(attribute)[1])-1,attribute=this.graphDef.columns[attribute];this.prefix=name,this.model.metrics.push({name:name,attribute:attribute,resourceId:this.resourceId,datasource:dsName,aggregation:consolFun})},_expressionRegexp:new RegExp("\\{([^}]*)}","g"),_onCDEF:function(name,rpnExpression){var expression=rpnExpression;this.convertRpnToJexl&&(expression=this.rpnConverter.convert(rpnExpression)),this.prefix&&(expression=expression.replace(this._expressionRegexp,this.prefix+".$1")),this.model.metrics.push({name:name,expression:expression})},_onVDEF:function(name,rpnExpression){this.model.values.push({name:name,expression:this.consolidator.parse(rpnExpression)})},_onLine:function(srcName,series,legend,width){series={name:this.displayString(legend),metric:srcName,type:"line",color:series};this.maybeAddPrintStatementForSeries(srcName,legend),this.model.series.push(series)},_onArea:function(srcName,series,legend){series={name:this.displayString(legend),metric:srcName,type:"area",color:series};this.maybeAddPrintStatementForSeries(srcName,legend),this.model.series.push(series)},_onStack:function(srcName,series,legend){series={name:this.displayString(legend),metric:srcName,type:"stack",color:series,legend:legend};this.maybeAddPrintStatementForSeries(srcName,legend),this.model.series.push(series)},_onGPrint:function(srcName,aggregation,format){var metricName;void 0===aggregation?this.model.printStatements.push({metric:srcName,format:format}):(metricName=srcName+"_"+aggregation+"_"+Math.random().toString(36).substring(2),this.model.values.push({name:metricName,expression:this.consolidator.parse([srcName,aggregation])}),this.model.printStatements.push({metric:metricName,format:format}))},_onComment:function(format){this.model.printStatements.push({format:format})},maybeAddPrintStatementForSeries:function(series,legend){null!=legend&&""!==legend&&this.model.printStatements.push({metric:series,value:NaN,format:"%g "+legend})}}),Backshift.namespace("Backshift.Graph"),Backshift.Graph=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(args){void 0===args.dataSource&&Backshift.fail("Graph needs a data source."),this.dataSource=args.dataSource,void 0===args.element&&Backshift.fail("Graph needs an element."),this.element=args.element,this.model=args.model||{},this.model.metrics||(this.model.metrics=[]),this.model.series||(this.model.series=[]),this.model.values||(this.model.values=[]),this.model.printStatements||(this.model.printStatements=[]),this._title=args.title||this.model.title,this._verticalLabel=args.verticalLabel||this.model.verticalLabel,this._regexes={},this._values={},this.configure(args),this.queryInProgress=!1,this.lastSuccessfulQuery=0,this.timer=null,this.onInit(args)},defaults:function(){return{width:400,height:240,resolution:0,start:0,end:0,last:0,refreshRate:0,beginOnRender:!0,stream:!0,checkInterval:15e3}},render:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null),this.onRender(),this.beginOnRender&&this.begin()},begin:function(){this.onBegin(),this.refresh(),this.createTimer(),this.stream&&this.startStreaming()},cancel:function(){this.destroyTimer(),this.stopStreaming(),this.onCancel()},resize:function(size){},destroy:function(){this.hideStatus(),this.destroyTimer(),this.onDestroy()},createTimer:function(){var self=this;self.destroyTimer(),self.timer=setInterval(function(){self.shouldRefresh()&&self.refresh()},self.checkInterval)},destroyTimer:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)},setStart:function(start){this.start=start,this.refresh()},setEnd:function(end){this.end=end,this.refresh()},refresh:function(){var timeSpan,self=this;self.dataSource&&self.dataSource.supportsQueries()&&(timeSpan=this.getTimeSpan(),this.queryInProgress=!0,this.onBeforeQuery(),this.dataSource.query(timeSpan.start,timeSpan.end,this.getResolution()).then(function(results){self.queryInProgress=!1,self.lastSuccessfulQuery=Date.now(),self.updateValues(results),self.updateTextFields(results),self.onQuerySuccess(results),self.onAfterQuery()},function(reason){self.queryInProgress=!1,self.onQueryFailed(reason),self.onAfterQuery()}))},startStreaming:function(){var self=this;self.dataSource&&self.dataSource.supportsStreaming()&&!self.isStreaming&&(self.isStreaming=!0,self.dataSource.callback=function(results){self.updateValues(results),self.updateTextFields(results),self.onQuerySuccess(results)},this.dataSource.startStreaming())},stopStreaming:function(){this.isStreaming&&(this.isStreaming=!1,this.dataSource&&this.dataSource.supportsStreaming()&&this.dataSource.stopStreaming())},updateValues:function(results){this._values={};for(var i=0;i<this.model.values.length;i++){var value=this.model.values[i];this._values[value.name]={metricName:value.expression.metricName,functionName:value.expression.functionName,argument:value.expression.argument,value:value.expression.consolidate(results)}}},updateTextFields:function(results){var re,title=this._title,verticalLabel=this._verticalLabel;if(this.model&&this.model.properties)for(var value in this.model.properties)this._regexes[value]||(this._regexes[value]=new RegExp("\\{"+value+"}","g")),re=this._regexes[value],value=results.constants&&results.constants[value]?results.constants[value]:"null",title=title&&title.replace(re,value),verticalLabel=verticalLabel&&verticalLabel.replace(re,value);this.title=title,this.verticalLabel=verticalLabel},shouldRefresh:function(){return!this.queryInProgress&&(0!==this.refreshRate&&this.lastSuccessfulQuery<=Date.now()-this.refreshRate)},getTimeSpan:function(){0===this.start&&0===this.end&&0===this.last&&Backshift.fail("Graph needs start and end, or last to be non-zero.");var timeSpan={};return 0<this.last?(timeSpan.end=Date.now(),timeSpan.start=timeSpan.end-this.last):(timeSpan.end=this.end,timeSpan.start=this.start),timeSpan},getResolution:function(){return 0<this.resolution?this.resolution:this.width},showStatus:function(statusText){this.statusElement?this.statusElement.text(statusText):this.element&&(this.statusElement=d3.select(this.element).insert("div",":first-child"),this.statusElement.attr("align","center").attr("class","backshift-status").text(statusText))},hideStatus:function(){this.statusElement&&this.statusElement.remove()},onInit:function(args){},onRender:function(){},onBegin:function(){},onCancel:function(){},onBeforeQuery:function(){},onQuerySuccess:function(results){},onQueryFailed:function(reason){console.log("Query failed with: "+reason)},onAfterQuery:function(){},onDestroy:function(){}}),Backshift.namespace("Backshift.DataSource"),Backshift.DataSource=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(args){void 0!==args.metrics&&0!==args.metrics.length||Backshift.fail("DataSource needs one or more metrics."),this.metrics=args.metrics,this.configure(args),this.onInit(args)},defaults:function(){return{}},query:function(start,end,resolution,args){},supportsQueries:function(){return!0},supportsStreaming:function(){return!1},onInit:function(args){}}),Backshift.namespace("Backshift.DataSource.SineWave"),Backshift.DataSource.SineWave=Backshift.Class.create(Backshift.DataSource,{defaults:function($super){return Backshift.extend($super(),{})},query:function(start,end,resolution,args){resolution<=0&&(resolution=end-end);for(var t,column,dfd=jQuery.Deferred(),numMetrics=this.metrics.length,columns=new Array(1+numMetrics),columnNames=new Array(1+numMetrics),columnNameToIndex={},k=0;k<=numMetrics;k++){if(column=new Array(resolution),columns[k]=column,0===k)for(columnNames[k]="timestamp",t=0;t<resolution;t++)column[t]=start+t/(resolution-1)*(end-start);else for(columnNames[k]=this.metrics[k-1].name,t=0;t<resolution;t++)column[t]=this._sin(columns[0][t],this.metrics[k-1]);columnNameToIndex[columnNames[k]]=k}return dfd.resolve({columns:columns,columnNames:columnNames,columnNameToIndex:columnNameToIndex}),dfd.promise()},_sin:function(t,metric){var amplitude=1,hshift=0,vshift=0,B=2*Math.PI;void 0!==metric.amplitude&&(amplitude=metric.amplitude),void 0!==metric.hshift&&(hshift=metric.hshift),void 0!==metric.vshift&&(vshift=metric.vshift),void 0!==B&&(B=metric.period);B=2*Math.PI/B;return amplitude*Math.sin(B*(t-hshift))+vshift}}),Backshift.namespace("Backshift.DataSource.OpenNMS"),Backshift.DataSource.OpenNMS=Backshift.Class.create(Backshift.DataSource,{defaults:function($super){return Backshift.extend($super(),{url:"http://127.0.0.1:8980/opennms/rest/measurements",username:null,password:null,fetchFunction:null})},onInit:function(args){this.fetchFunction||(this.fetchFunction=this.post)},post:function(url,data,onSuccess,onFailure){var withCredentials=null!==this.username&&null!==this.password,headers={};withCredentials&&(headers.Authorization="Basic "+window.btoa(this.username+":"+this.password)),jQuery.ajax({url:url,xhrFields:{withCredentials:withCredentials},headers:headers,type:"POST",data:JSON.stringify(data),contentType:"application/json",dataType:"json",success:onSuccess,error:onFailure})},query:function(start,end,data,args){var self=this,dfd=jQuery.Deferred(),data=self._getQueryRequest(start,end,data);return self.fetchFunction(self.url,data,function(response){dfd.resolve(self._parseResponse(response=void 0===response?{labels:[],timestamps:[],columns:[]}:response))},function(jqXmr,textStatus){dfd.reject(textStatus)}),dfd.promise()},_getQueryRequest:function(start,end,resolution){var qrSource,queryRequest={start:start,end:end,step:0<resolution?Math.floor((end-start)/resolution):1,source:[],expression:[],filter:[]},timeDeltaInSeconds=end-start;return Backshift.keys(this.metrics).forEach(function(metric){metric=this.metrics[metric];void 0!==metric.resourceId?(qrSource={aggregation:metric.aggregation,attribute:metric.attribute,label:metric.name,resourceId:metric.resourceId,transient:metric.transient},void 0!==metric.datasource&&metric.attribute!==metric.datasource&&(qrSource.datasource=metric.datasource),queryRequest.source.push(qrSource)):"filter"===metric.type?queryRequest.filter.push({name:metric.name,parameter:metric.parameter}):((qrSource={value:metric.expression,label:metric.name,transient:metric.transient}).value=qrSource.value.replace("{diffTime}",timeDeltaInSeconds),queryRequest.expression.push(qrSource))},this),0===queryRequest.source.length&&delete queryRequest.source,0===queryRequest.expression.length&&delete queryRequest.expression,0===queryRequest.filter.length&&delete queryRequest.filter,queryRequest},_parseResponse:function(json){var k,parts,numMetrics=json.labels.length,columns=new Array(1+numMetrics),columnNames=new Array(1+numMetrics),columnNameToIndex={};for(columns[0]=json.timestamps,columnNames[0]="timestamp",k=columnNameToIndex.timestamp=0;k<numMetrics;k++)columns[1+k]=json.columns[k].values,columnNames[1+k]=json.labels[k],columnNameToIndex[columnNames[1+k]]=1+k;if(json.constants)for(var key,value,constants={},c=0,len=json.constants.length;c<len;c++)key=json.constants[c].key,value=json.constants[c].value,1<(parts=key.split(".")).length&&(constants[key=parts[1]]=void 0===value?null:value);return{columns:columns,columnNames:columnNames,columnNameToIndex:columnNameToIndex,constants:constants}}}),Backshift.namespace("Backshift.DataSource.NRTG"),Backshift.DataSource.NRTG=Backshift.Class.create(Backshift.DataSource,{defaults:function($super){return Backshift.extend($super(),{url:"http://127.0.0.1:8980/opennms/nrt/starter",callback:function(){},username:null,password:null,getFunction:null,slidingWindow:30,pollingInterval:1e3})},onInit:function(args){this.getFunction||(this.getFunction=this.get),1!==this.metrics.length&&Backshift.fail("NRTG only supports streaming a single metric."),this.lastMeasurementSet={},this.rows=[],this.pollingIntervalId=null},supportsQueries:function(){return!1},supportsStreaming:function(){return!0},startStreaming:function(){var self=this,dfd=jQuery.Deferred();return self.getFunction(this.url,{resourceId:self.metrics[0].resourceId,report:self.metrics[0].report},function(nrtgCollectionDetails){self.handleCollectionDetails(nrtgCollectionDetails),dfd.resolve()},function(jqXmr,textStatus){dfd.reject(textStatus)}),dfd.promise()},stopStreaming:function(){null!==this.pollingIntervalId&&(clearInterval(this.pollingIntervalId),this.pollingIntervalId=null)},updatePollingInterval:function(poll){var self=this;self.pollingInterval=poll,null!==self.pollingIntervalId&&(clearInterval(self.pollingIntervalId),poll=function(){self.poll()}.bind(self),self.pollingIntervalId=setInterval(poll,self.pollingInterval))},updateSlidingWindow:function(slidingWindow){this.slidingWindow=slidingWindow,this._processRowsAndNotify()},handleCollectionDetails:function(poll){var self=this,rrdGraphConverter={command:poll.rrdGraphString,externalValues:[],propertiesValues:[],columns:self._metricMappingsToColumns(poll.metricsMapping)},rrdGraphConverter=new Backshift.Utilities.RrdGraphConverter({graphDef:rrdGraphConverter,resourceId:self.metrics[0].resourceId,convertRpnToJexl:!1});self.model=rrdGraphConverter.model,self.collectionTaskId=poll.collectionTaskId;poll=function(){self.poll()}.bind(self);poll(),self.pollingIntervalId=setInterval(poll,self.pollingInterval)},poll:function(){var self=this;!0!==self.pollInProgress&&(self.pollInProgress=!0,self.getFunction(self.url,{poll:!0,nrtCollectionTaskId:self.collectionTaskId},function(data){self.pollInProgress=!1,self._calculateMeasurements(data.measurement_sets),self._processRowsAndNotify()},function(jqXmr,textStatus){self.pollInProgress=!1,console.log("NRTG: Poll failed with '"+textStatus+"'.")}))},_metricMappingsToColumns:function(metricsMapping){for(var columns=[],i=1,nmetrics=Object.keys(metricsMapping).length;i<=nmetrics;i++){var key,found=!1;for(key in metricsMapping)if(metricsMapping.hasOwnProperty(key)&&-1<metricsMapping[key].indexOf("{rrd"+i+"}")){columns.push(key),found=!0;break}found||Backshift.fail("Missing {rrd"+i+"}")}return columns},_calculateRate:function(lastMetric,newMetric){return null===lastMetric||null===newMetric||isNaN(lastMetric.value)||isNaN(newMetric.value)?NaN:(newMetric.value-lastMetric.value)/(newMetric.timeStamp-lastMetric.timeStamp)*1e3},_calculateMeasurements:function(measurementSets){for(var i=0,nsets=measurementSets.length;i<nsets;i++){for(var metricsById={},timestamp=0,j=0,nmetrics=measurementSets[i].length;j<nmetrics;j++)timestamp=(metricsById[(metric=measurementSets[i][j]).metricId]=metric).timeStamp;for(var rpnEvaluator=new Backshift.Utilities.RpnEvaluator,row={timestamp:timestamp},j=0,nmetrics=this.model.metrics.length;j<nmetrics;j++){var metric,lastMetric,modelMetric=this.model.metrics[j],value=NaN;"expression"in modelMetric?value=rpnEvaluator.evaluate(modelMetric.expression,row):modelMetric.attribute in metricsById&&(value=(metric=metricsById[modelMetric.attribute]).value,-1<metric.metricType.indexOf("counter")&&(lastMetric=null,modelMetric.attribute in this.lastMeasurementSet&&(lastMetric=this.lastMeasurementSet[modelMetric.attribute]),value=this._calculateRate(lastMetric,metric))),row[modelMetric.name]=value}this.rows.push(row),this.lastMeasurementSet=metricsById}},_processRowsAndNotify:function(){for(var indexOfFirstRow=0,columns={},i=indexOfFirstRow=0<this.slidingWindow&&(indexOfFirstRow=this.rows.length-this.slidingWindow)<0?0:indexOfFirstRow,nrows=this.rows.length;i<nrows;i++){var key,row=this.rows[i];for(key in row)row.hasOwnProperty(key)&&(key in columns?columns[key].push(row[key]):columns[key]=[row[key]])}for(j=0,nmetrics=this.model.metrics.length;j<nmetrics;j++){var modelMetric=this.model.metrics[j];modelMetric.transient&&delete columns[modelMetric.name]}var results={columns:[],columnNames:[],columnNameToIndex:{}};$.each(columns,function(columnName,columnValues){results.columns.push(columnValues),results.columnNames.push(columnName),results.columnNameToIndex[columnName]=results.columns.length-1}),this.callback(results)},get:function(url,data,onSuccess,onFailure){var withCredentials=null!==this.username&&null!==this.password,headers={};withCredentials&&(headers.Authorization="Basic "+window.btoa(this.username+":"+this.password)),jQuery.ajax({url:url,xhrFields:{withCredentials:withCredentials},headers:headers,type:"GET",cache:!1,data:data,dataType:"json",success:onSuccess,error:onFailure})}}),Backshift.namespace("Backshift.Graph.Matrix"),Backshift.Graph.Matrix=Backshift.Class.create(Backshift.Graph,{onInit:function(){this.statusBlock=null},onBeforeQuery:function(){this.timeBeforeQuery=Date.now(),this.updateStatus("Querying...")},onQuerySuccess:function(queryDuration){this.drawMatrix(queryDuration);queryDuration=Date.now(),queryDuration=Number((queryDuration-this.timeBeforeQuery)/1e3).toFixed(2);this.updateStatus("Successfully retrieved data in "+queryDuration+" seconds.")},onQueryFailed:function(){this.updateStatus("Query failed.")},updateStatus:function(status){this.statusBlock?this.statusBlock.text(status):this.statusBlock=d3.select(this.element).append("p").attr("align","right").text(status)},drawMatrix:function(results){for(var k,numRows=results.columns[0].length,numColumns=results.columnNames.length,rows=new Array(numRows),i=0;i<numRows;i++)for(rows[i]={},k=0;k<numColumns;k++)rows[i][results.columnNames[k]]=results.columns[k][i];var status="";this.statusBlock&&(status=this.statusBlock.text()),d3.select(this.element).selectAll("*").remove(),this.statusBlock=d3.select(this.element).append("p").attr("align","right").text(status),this.tabulate(this.element,rows,results.columnNames),d3.select(this.element).attr("data-results",JSON.stringify(results)),d3.select(this.element).attr("data-rendered-at",Date.now())},tabulate:function(tbody,data,columns){var table=d3.select(tbody).append("table").attr("style","font-size: 10px"),thead=table.append("thead"),tbody=table.append("tbody");return thead.append("tr").selectAll("th").data(columns).enter().append("th").text(function(column){return column}),tbody.selectAll("tr").data(data).enter().append("tr").selectAll("td").data(function(row){return columns.map(function(column){return{column:column,value:row[column]}})}).enter().append("td").attr("style","font-family: Courier; padding:0 15px 0 15px;").attr("align","center").html(function(d){return Number(d.value).toFixed(4)}),table}}),Backshift.namespace("Backshift.Graph.Flot"),Backshift.Graph.Flot=Backshift.Class.create(Backshift.Graph,{defaults:function($super){return Backshift.extend($super(),{width:"100%",height:"100%",title:void 0,verticalLabel:void 0,zoom:!0,xaxisFont:void 0,yaxisFont:void 0,legendFontSize:void 0,ticks:void 0})},onInit:function(){var container=jQuery(this.element);container.width(this.width),container.height(this.height)},showStatus:function(text){var options,canvas;this.chart&&(options=this.chart.getOptions(),canvas=this.chart.getCanvas(),options&&(options._oldTitle||(options._oldTitle=options.title),options.title=text,options.canvas&&canvas&&this.chart.draw()))},hideStatus:function(){var options,canvas;this.chart&&(options=this.chart.getOptions(),canvas=this.chart.getCanvas(),options&&(options._oldTitle&&(options.title=options._oldTitle,delete options._oldTitle),options.canvas&&canvas&&this.chart.draw()))},onBeforeQuery:function(){this.showStatus("Loading..."),this.doRender=!0},onQueryFailed:function(){this.showStatus("Query failed.")},onQuerySuccess:function(results){this.hideStatus(),this.doRender&&this.drawChart(results)},onRender:function(){this.doRender=!0,this.drawChart()},onCancel:function(){this.doRender=!1,this.drawChart()},_shouldStack:function(k){if("area"===this.model.series[k].type)for(var n=this.model.series.length,i=k;i<n;i++)if("stack"===this.model.series[i].type)return 1;return"stack"===this.model.series[k].type},drawChart:function(results){var container=jQuery(this.element),timestamps=[];results&&results.columns&&(timestamps=results.columns[0]);for(var series,values,j,shouldStack,shouldFill,seriesValues,shouldShow,from,to,numSeries=this.model.series.length,numValues=timestamps.length,i=1;i<numValues;i++)if(timestamps[i]<timestamps[i-1])throw"Timestamps are not properly ordered! ("+timestamps[i]+" < "+timestamps[i-1]+")";2<=numValues&&(from=timestamps[0],to=timestamps[timestamps.length-1]),this.flotSeries=[],this.hiddenFlotSeries=[];var lastSeriesToStackWith=null;for(i=0;i<numSeries;i++){for(flotSeries="data"+i,(series=this.model.series[i]).metric&&results&&results.columns&&(values=results.columns[results.columnNameToIndex[series.metric]]),shouldStack=this._shouldStack(i),shouldFill="stack"===this.model.series[i].type||"area"===this.model.series[i].type,shouldShow="hidden"!==this.model.series[i].type,"area"===this.model.series[i].type&&(lastSeriesToStackWith=null),seriesValues=[],j=0;j<numValues;j++){var yOffset=0;shouldStack&&null!=lastSeriesToStackWith&&(yOffset=lastSeriesToStackWith.data[j][1]);var yVal=isNaN(values[j])?values[j]:values[j]+yOffset;seriesValues.push([timestamps[j],yVal,yOffset])}void 0===series.color&&(shouldFill=0);var flotSeries={label:series.name,color:series.color,lines:{show:!0,fill:shouldFill,fillColor:series.color},data:seriesValues,originalY:values,id:flotSeries,metric:series.metric,nodatatable:void 0===series.name||null===series.name||""===series.name};shouldShow?(this.flotSeries.push(flotSeries),shouldStack&&(lastSeriesToStackWith=flotSeries)):this.hiddenFlotSeries.push(flotSeries)}var yaxisTickFormat=d3.format(".3s"),legendStatements=[];for(i=0;i<this.model.printStatements.length;i++){var value,printStatement=this.model.printStatements[i];printStatement.metric in this._values?(value=this._values[printStatement.metric],legendStatements.push({metric:value.metricName,value:value.value[1],timestamp:value.value[0],format:printStatement.format})):results&&legendStatements.push({metric:printStatement.metric,value:NaN,timestamp:void 0,format:printStatement.format})}var yaxis={canvas:!0,title:this.title||"",axisLabels:{show:!0},hooks:{draw:[this.drawHook]},series:{lines:{zero:!1},bars:{fill:1,barWidth:1,zero:!1,lineWidth:0},points:{fill:1,fillColor:!1},shadowSize:1},yaxis:{tickFormatter:yaxisTickFormat},yaxes:[{position:"left",axisLabel:this.verticalLabel||"",axisLabelUseHtml:!1,axisLabelUseCanvas:!0}],xaxis:{},grid:{minBorderMargin:0,markings:[],backgroundColor:null,borderWidth:0,hoverable:!0,color:"#c8c8c8",margin:{left:0,right:0,top:25,bottom:0}},selection:{mode:"x",color:"#666"},legend:{show:!1,statements:legendStatements},hiddenSeries:this.hiddenFlotSeries,tooltip:{show:!0},datatable:{xaxis:{label:"Date/Time",format:function(x){return d3.time.format("%c")(new Date(x))}},yaxis:{ignoreColumnsWithNoLabel:!0,format:function(y){try{return yaxisTickFormat(y)}catch(err){return NaN}}}},zoom:{interactive:!0},pan:{interactive:!0}};this.addTimeAxis(yaxis,from,to),this.xaxisFont&&(yaxis.xaxis.font=this.getFontSpec(this.xaxisFont)),this.yaxisFont&&(yaxis.yaxis.font=this.getFontSpec(this.yaxisFont)),this.legendFontSize&&(yaxis.legend.style||(yaxis.legend.style={}),yaxis.legend.style.fontSize=this.legendFontSize),this.chart=jQuery.plot(container,this.flotSeries,yaxis);yaxis=this.chart.getAxes().yaxis;this.chart.ranges={yaxis:{panRange:[yaxis.min,yaxis.max],zoomRange:!1},xaxis:{panRange:[from,to],zoomRange:null}}},getFontSpec:function(fontSpec){var ret={size:"inherit",family:"inherit",style:"inherit",weight:"inherit",variant:"inherit",color:"inherit"};return fontSpec&&(fontSpec.size&&(ret.size=fontSpec.size),fontSpec.family&&(ret.family=fontSpec.family),fontSpec.style&&(ret.style=fontSpec.style),fontSpec.weight&&(ret.weight=fontSpec.weight),fontSpec.variant&&(ret.variant=fontSpec.variant),fontSpec.color&&(ret.color=fontSpec.color)),ret},drawHook:function(plot,canvascontext){var cx=canvascontext.canvas.clientWidth/2;canvascontext.font="15px sans-serif",canvascontext.textAlign="center",canvascontext.fillText(plot.getOptions().title,cx,15)},addTimeAxis:function(options,from,to){var ticks=jQuery(this.element),ticks=this.ticks||ticks.width()/100;options.xaxis={mode:"time",timezone:"browser",min:from,max:to,label:"Datetime",ticks:ticks,timeformat:this.time_format(ticks,from,to)}},time_format:function(secPerTick,min,max){if(min&&max&&secPerTick){secPerTick=(max-min)/secPerTick/1e3;return secPerTick<=45?"%H:%M:%S":secPerTick<=7200?"%H:%M":secPerTick<=8e4?"%m/%d %H:%M":secPerTick<=2419200?"%m/%d":"%Y-%m"}return"%H:%M"},onDestroy:function(){this.chart&&this.chart.destroy&&(this.chart.shutdown(),this.chart.destroy())}}),Backshift.namespace("Backshift.Graph.C3"),Backshift.Graph.C3=Backshift.Class.create(Backshift.Graph,{defaults:function($super){return Backshift.extend($super(),{width:void 0,height:void 0,title:void 0,verticalLabel:void 0,clipboardData:void 0,exportIconSizeRatio:.05,interactive:!0,step:!1,zoom:!0})},onInit:function(){this.columns=[],this.groups=[],this.colorMap={},this.typeMap={},this.nameMap={},this.clipboardPrimed=!1,0<this.exportIconSizeRatio&&document.addEventListener("copy",this._onClipboardCopy),this.chart=null},resize:function(size){this.width=size.width,this.height=size.height,null!==this.chart&&this.chart.resize(size)},destroy:function($super){$super(),null!==this.chart&&(this.chart=this.chart.destroy())},onRender:function(){this._updatePlot()},_shouldStack:function(k){if("area"===this.model.series[k].type)for(var n=this.model.series.length,i=k;i<n;i++)if("stack"===this.model.series[i].type)return 1;return"stack"===this.model.series[k].type},_getDisplayName:function(name){return null==name?null:name},_getType:function(derivedType,shouldStack){derivedType=!0===shouldStack?"area":derivedType;return this.step&&("line"===derivedType?derivedType="step":"area"===derivedType&&(derivedType="area-step")),derivedType},onBeforeQuery:function(){this.showStatus("Loading...")},onQuerySuccess:function(results){if(results&&results.columns){var series,values,i,j,X,Y,columnName,shouldStack,timestamps=results.columns[0],numSeries=this.model.series.length,numValues=timestamps.length;for(this.columns=[],X=["timestamp"],i=0;i<numValues;i++)X.push(timestamps[i]);this.columns[0]=X;var group=[];for(this.groups=[group],i=0;i<numSeries;i++){for(series=this.model.series[i],values=results.columns[results.columnNameToIndex[series.metric]],Y=[columnName="data"+i],j=0;j<numValues;j++)Y.push(values[j]);this.columns[i+1]=Y,this.colorMap[columnName]=series.color,this.nameMap[columnName]=this._getDisplayName(series.name),(shouldStack=this._shouldStack(i))&&group.push(columnName),this.typeMap[columnName]=this._getType(series.type,shouldStack)}this.hideStatus(),this._updatePlot()}},onQueryFailed:function($super,reason){$super(reason),this.showStatus("Query failed.")},showStatus:function(statusText){var boundingRect,svg=d3.select(this.element).select("svg");svg&&(boundingRect=svg.node().getBoundingClientRect(),svg.select("#chart-status-text").remove(),statusText&&svg.append("text").attr("id","chart-status-text").attr("x",boundingRect.width/2).attr("y",boundingRect.height/2.5).attr("text-anchor","middle").style("font-size","2.5em").text(statusText))},hideStatus:function(){var svg=d3.select(this.element).select("svg");svg&&svg.select("#chart-status-text").remove()},_onToggleCsvExport:function(el){var iconColor="black";if(this.clipboardPrimed)window.backshift_c3_clipboard=void 0,this.clipboardPrimed=!1;else{for(var j,iconColor="green",csv="",numColumns=this.columns.length,numRows=0<numColumns?this.columns[0].length-1:0,i=0;i<numColumns;i++)0==i?csv="Timestamp":csv+=","+this.nameMap[this.columns[i][0]];for(i=1;i<=numRows;i++)for(csv+="\n",j=0;j<numColumns;j++)0<j&&(csv+=","),csv+=this.columns[j][i];window.backshift_c3_clipboard=csv,this.clipboardPrimed=!0}d3.select(el).style("fill",iconColor)},_onClipboardCopy:function(e){void 0!==window.backshift_c3_clipboard&&(-1!=navigator.userAgent.toLowerCase().indexOf("msie")||-1!=navigator.userAgent.toLowerCase().indexOf("trident")?window.clipboardData.setData("Text",window.backshift_c3_clipboard):e.clipboardData.setData("text/plain",window.backshift_c3_clipboard),e.preventDefault())},_onRendered:function(){var sizeInPixels,self=this,svg=d3.select(this.element).select("svg"),boundingRect=svg.node().getBoundingClientRect();svg.select("#export-to-csv").remove(),0<this.columns.length&&0<this.exportIconSizeRatio&&(sizeInPixels=Math.min(boundingRect.width,boundingRect.height)*this.exportIconSizeRatio,svg.append("text").attr("id","export-to-csv").attr("x",boundingRect.width-sizeInPixels).attr("y",sizeInPixels).attr("font-family","FontAwesome").attr("font-size",function(d){return sizeInPixels+"px"}).text(function(d){return""}).on("click",function(){return self._onToggleCsvExport(this,self)}))},_updatePlot:function(){var timestamps,difference,self=this,plotConfig={bindto:d3.select(this.element),interaction:{enabled:this.interactive},data:{x:"timestamp",columns:this.columns,types:this.typeMap,names:this.nameMap,colors:this.colorMap,groups:this.groups,order:null},size:{width:this.width,height:this.height},axis:{x:{type:"timeseries",tick:{}},y:{label:self.verticalLabel,tick:{format:d3.format(".2s")}}},grid:{x:{show:!0},y:{show:!0}},transition:{duration:0},point:{show:!1},zoom:{enabled:this.zoom},onrendered:function(){self._onRendered()},title:{text:this.title},tooltip:{format:{title:function(d){return d},value:function(value,ratio,id){return d3.format(".4s")(value)}}}};self.columns&&0<self.columns.length?(plotConfig.axis.x.tick.count=30,(timestamps=self.columns[0])&&2<=timestamps.length&&(difference=timestamps[1],(difference=timestamps[timestamps.length-1]-difference)<9e7?(plotConfig.axis.x.tick.format="%H:%M",plotConfig.axis.x.tick.count=24):difference<12096e5?(plotConfig.axis.x.tick.format="%a %b %d",plotConfig.axis.x.tick.count=14):difference<7776e6?(plotConfig.axis.x.tick.format="%b %d",plotConfig.axis.x.tick.count=30):(plotConfig.axis.x.tick.format="%b %Y",plotConfig.axis.x.tick.count=12))):delete plotConfig.axis.x.tick.count,self.chart=c3.generate(plotConfig)}}),Backshift.namespace("Backshift.Graph.DC"),Backshift.Graph.DC=Backshift.Class.create(Backshift.Graph,{defaults:function($super){return Backshift.extend($super(),{width:void 0,height:void 0,title:void 0,verticalLabel:void 0,step:!1,zoom:!0,interpolate:"linear",tension:void 0})},onInit:function(){this.statusBlock=null,this.idPrefix=(new Date).getTime()+""+Math.floor(1e5*Math.random()),this.crossfilter=crossfilter([]),this.dateDimension=this.crossfilter.dimension(function(d){return d.timestamp}),this.renderGraphs()},onBeforeQuery:function(){this.showStatus("Loading...")},onQuerySuccess:function(results){this.hideStatus(),this.updateData(results)},onQueryFailed:function($super,reason){$super(reason),this.showStatus("Query failed."),this.renderGraphs()},onCancel:function(){this.crossfilter.groupAll(),this.crossfilter.remove()},showStatus:function(statusText){var boundingRect,svg=this.chart.svg();svg&&(boundingRect=svg.node().getBoundingClientRect(),svg.select("#chart-status-text").remove(),statusText&&svg.append("text").attr("id","chart-status-text").attr("x",boundingRect.width/2).attr("y",boundingRect.height/2.5).attr("text-anchor","middle").style("font-size","2.5em").text(statusText))},hideStatus:function(){this.chart.svg().select("#chart-status-text").remove()},updateData:function(results){for(var k,row,numRows=results.columns[0].length,numColumns=results.columnNames.length,rows=[],i=0;i<numRows;i++){for(row={},k=0;k<numColumns;k++)val=results.columns[k][i],0===k&&(val=new Date(val)),null!==val&&void 0!==val&&"NaN"!==val&&!isNaN(val)||(val=NaN),row[results.columnNames[k]]=val;rows.push(row)}this.crossfilter.groupAll(),this.crossfilter.remove(),this.crossfilter.add(rows);var xunits=new Date,minTime=this.dateDimension.bottom(1),maxTime=this.dateDimension.top(1),minTime=0===minTime.length?xunits:minTime[0].timestamp,xunits=(maxTime=0===maxTime.length?xunits:maxTime[0].timestamp).getTime()-minTime.getTime(),xunits=xunits<9e7?d3.time.hours:xunits<12096e5?d3.time.days:xunits<7776e6?d3.time.months:d3.time.years;this.chart&&this.chart.elasticX(!1).elasticY(!0).x(d3.time.scale().domain([minTime,maxTime])).round(xunits.round).xUnits(xunits).render(),this.renderGraphs()},renderGraphs:function(){var self=this,timeFormat=d3.time.format("%Y-%m-%d %H:%M:%S"),numberFormat=d3.format(".2s"),legend=self.element.getAttribute("data-graph-model"),id=(legend=void 0===legend?self.element.getAttribute("data-graph-name"):legend)+self.idPrefix;self.element.id=id,jQuery(self.element).css("max-height",self.height).css("max-width",self.width).css("position","relative").css("float","none");var columnGroups=[];for(i=0;i<self.model.series.length;i++){var columnName=self.model.series[i].metric;columnGroups[i]=function(columnName){return self.dateDimension.group().reduce(function(p,v){return isNaN(v[columnName])?p.nanCount++:p.total+=v[columnName],0<p.nanCount?p.value=NaN:p.value=p.total,p},function(p,v){return isNaN(v[columnName])?p.nanCount--:p.total-=v[columnName],0<p.nanCount?p.value=NaN:p.value=p.total,p},function(){return{nanCount:0,total:0,value:NaN}})}(columnName)}if(self.chart)self.chart.redraw();else{function accessor(d){return d.value.value}function definedFunc(d){return!isNaN(d.y)}for(var ser,lastChart,lastSeries,nextSeries,currentChart,chart=dc.compositeChart("#"+id),charts=[],colors=[],i=0;i<self.model.series.length;i++)0<charts.length&&(lastChart=charts[charts.length-1]),ser=self.model.series[i],0<i&&(lastSeries=self.model.series[i-1]),self.model.series[i+1]&&(nextSeries=self.model.series[i+1]),"area"===ser.type&&void 0===ser.name&&nextSeries&&"line"===nextSeries.type&&ser.metric===nextSeries.metric||("area"===ser.type?(colors.length&&lastChart.ordinalColors(colors),colors=[ser.color],currentChart=dc.lineChart(chart).renderArea(!0).group(columnGroups[i],ser.name).valueAccessor(accessor).defined(definedFunc),charts.push(currentChart)):"line"===ser.type?(colors.length&&lastChart.ordinalColors(colors),colors=[ser.color],currentChart=dc.lineChart(chart).group(columnGroups[i],ser.name).valueAccessor(accessor).defined(definedFunc),lastSeries&&"area"===lastSeries.type&&lastSeries.metric===ser.metric&&currentChart.renderArea(!0),charts.push(currentChart)):"stack"===ser.type&&(lastChart.stack(columnGroups[i],ser.name),colors.push(ser.color))),this.step&&currentChart?currentChart.interpolate("step-after"):this.interpolate&&currentChart&&currentChart.interpolate(this.interpolate),this.tension&&currentChart.tension(this.tension);colors.length&&charts[charts.length-1].ordinalColors(colors);chart.renderHorizontalGridLines(!0).renderVerticalGridLines(!0).width(self.width).height(self.height).margins({top:30,right:20,bottom:65,left:50}).transitionDuration(0).mouseZoomable(this.zoom).zoomOutRestrict(!0).dimension(self.dateDimension),chart.x(d3.scale.ordinal()).yAxisLabel(self.verticalLabel,14).elasticY(!0),chart.renderTitle(!0).title(function(p){return timeFormat(p.key)+": "+numberFormat(p.value.value)});legend=dc.legend().x(50).y(self.height-25-10).itemHeight(10).gap(5).legendWidth(self.width-140).horizontal(!0).autoItemWidth(!0);chart.legend(legend),chart.xAxis().ticks(6),chart.yAxis().tickFormat(numberFormat),self.title&&chart.on("renderlet",function(boundingRect){var svg=boundingRect.svg();svg.select("#"+id+"-chart-background").remove(),svg.insert("rect",":first-child").attr("id",id+"-chart-background").attr("width","100%").attr("height","100%").attr("fill","white");boundingRect=svg.node().getBoundingClientRect();svg.select("#"+id+"-chart-title").remove(),svg.append("text").attr("id",id+"-chart-title").attr("x",boundingRect.width/2).attr("y","20").attr("text-anchor","middle").style("font-size","1em").text(self.title)}),chart.compose(charts).brushOn(!1).render(),self.chart=chart}}});