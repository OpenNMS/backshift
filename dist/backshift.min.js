/*! backshift 1.0.0 - built on 2015-06-15 */
Function.prototype.bind||(Function.prototype.bind=function(oThis){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};return fNOP.prototype=this.prototype,fBound.prototype=new fNOP,fBound});var Backshift=Backshift||{};Backshift.namespace=function(ns_string){var i,parts=ns_string.split("."),parent=Backshift;for("Backshift"===parts[0]&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)"undefined"==typeof parent[parts[i]]&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent},Backshift.keys=function(obj){var keys=[];for(var key in obj)obj.hasOwnProperty(key)&&keys.push(key);return keys},Backshift.extend=function(destination,source){for(var property in source)source.hasOwnProperty(property)&&(destination[property]=source[property]);return destination},Backshift.rows=function(matrix){var ncols=matrix.length;if(0===ncols)return[];for(var nrows=matrix[0].length,rows=new Array(nrows),i=0;nrows>i;i++){for(var row=new Array(ncols),j=0;ncols>j;j++)row[j]=matrix[j][i];rows[i]=row}return rows},Backshift.fail=function(msg){throw console.log("Error: "+msg),"Error: "+msg},Backshift.clone=function(obj){return JSON.parse(JSON.stringify(obj))},function(globalContext){function isFunction(object){return _toString.call(object)===FUNCTION_CLASS}function extend(destination,source){for(var property in source)source.hasOwnProperty(property)&&(destination[property]=source[property]);return destination}function keys(object){var results=[];for(var property in object)object.hasOwnProperty(property)&&results.push(property);return results}function isUndefined(object){return"undefined"==typeof object}function argumentNames(fn){var names=fn.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=names.length||names[0]?names:[]}function wrap(fn,wrapper){var __method=fn;return function(){var a=update([bind(__method,this)],arguments);return wrapper.apply(this,a)}}function update(array,args){for(var arrayLength=array.length,length=args.length;length--;)array[arrayLength+length]=args[length];return array}function merge(array,args){return array=slice.call(array,0),update(array,args)}function bind(fn,context){if(arguments.length<2&&isUndefined(arguments[0]))return this;var __method=fn,args=slice.call(arguments,2);return function(){var a=merge(args,arguments);return __method.apply(context,a)}}var _toString=Object.prototype.toString,FUNCTION_CLASS="[object Function]",slice=Array.prototype.slice,emptyFunction=function(){},Class=function(){function subclass(){}function create(){function klass(){this.initialize.apply(this,arguments)}var parent=null,properties=[].slice.apply(arguments);if(isFunction(properties[0])&&(parent=properties.shift()),extend(klass,Class.Methods),klass.superclass=parent,klass.subclasses=[],parent){subclass.prototype=parent.prototype,klass.prototype=new subclass;try{parent.subclasses.push(klass)}catch(e){}}for(var i=0,length=properties.length;length>i;i++)klass.addMethods(properties[i]);return klass.prototype.initialize||(klass.prototype.initialize=emptyFunction),klass.prototype.constructor=klass,klass}function addMethods(source){var ancestor=this.superclass&&this.superclass.prototype,properties=keys(source);IS_DONTENUM_BUGGY&&(source.toString!=Object.prototype.toString&&properties.push("toString"),source.valueOf!=Object.prototype.valueOf&&properties.push("valueOf"));for(var i=0,length=properties.length;length>i;i++){var property=properties[i],value=source[property];if(ancestor&&isFunction(value)&&"$super"==argumentNames(value)[0]){var method=value;value=wrap(function(m){return function(){return ancestor[m].apply(this,arguments)}}(property),method),value.valueOf=bind(method.valueOf,method),value.toString=bind(method.toString,method)}this.prototype[property]=value}return this}var IS_DONTENUM_BUGGY=function(){for(var p in{toString:1})if("toString"===p)return!1;return!0}();return{create:create,Methods:{addMethods:addMethods}}}();globalContext.exports?globalContext.exports.Class=Class:globalContext.Class=Class}(Backshift),Backshift.namespace("Backshift.Class.Configurable"),Backshift.Class.Configurable=Backshift.Class.create({configure:function(args){args=args||{},Backshift.keys(this.defaults()).forEach(function(key){return args.hasOwnProperty(key)?void(null!==this.defaults()[key]&&"object"==typeof this.defaults()[key]?Backshift.keys(this.defaults()[key]).forEach(function(k){this[key][k]=void 0!==args[key][k]?args[key][k]:void 0!==this[key][k]?this[key][k]:this.defaults()[key][k]},this):this[key]=void 0!==args[key]?args[key]:void 0!==this[key]?this[key]:this.defaults()[key]):void(this[key]=this[key]||this.defaults()[key])},this)}}),Backshift.namespace("Backshift.Math"),Backshift.Math={},Backshift.Math.lcm=function(A){if(void 0===A||A.length<1)return 0;for(var n=A.length,a=Math.abs(A[0]),i=1;n>i;i++){for(var b=Math.abs(A[i]),c=a;a&&b;)a>b?a%=b:b%=a;a=Math.abs(c*A[i])/(a+b)}return a},Backshift.namespace("Backshift.Stats"),Backshift.Stats={},Backshift.Stats.Maximum=function(array){var k,max=NaN;for(k=array.length;k--;)isNaN(array[k])||(isNaN(max)?max=array[k]:array[k]>max&&(max=array[k]));return max},Backshift.Stats.Minimum=function(array){var k,min=NaN;for(k=array.length;k--;)isNaN(array[k])||(isNaN(min)?min=array[k]:array[k]<min&&(min=array[k]));return min},Backshift.Stats.Average=function(array){if(0===array.length)return NaN;var k,sum=0,n=0;for(k=array.length;k--;)isNaN(array[k])||(sum+=array[k],n++);return 1>n?NaN:sum/n},Backshift.Stats.StdDev=function(array){if(array.length<2)return NaN;for(var m=0,m2=0,len=array.length,i=0;len>i;++i)if(!isNaN(array[i])){var v=array[i],d=v-m;m+=d/(i+1),m2+=d*(v-m)}return Math.sqrt(m2/(len-1))},Backshift.Stats.Last=function(array){var k;for(k=array.length;k--;)if(!isNaN(array[k]))return array[k];return NaN},Backshift.Stats.First=function(array){var k,n=array.length;for(k=0;n>k;k++)if(!isNaN(array[k]))return array[k];return NaN},Backshift.Stats.Total=function(array){if(0===array.length)return NaN;var k,sum=0;for(k=array.length;k--;)isNaN(array[k])||(sum+=array[k]);return sum},Backshift.Stats.Map={max:Backshift.Stats.Maximum,min:Backshift.Stats.Minimum,avg:Backshift.Stats.Average,stdev:Backshift.Stats.StdDev,last:Backshift.Stats.Last,first:Backshift.Stats.First,total:Backshift.Stats.Total},Backshift.namespace("Backshift.Utilities.Url"),Backshift.Utilities.Url=Backshift.Class.create({initialize:function(baseUrl){this.url=baseUrl,this.paramCount=0},andParam:function(kw,parameter){var sep=this.paramCount>0?"&":"?";return void 0!==parameter&&(this.paramCount+=1,this.url=this.url+sep+kw+"="+parameter),this},toString:function(){return this.url}}),Backshift.namespace("Backshift.Utilities.RpnToJexlConverter"),Backshift.Utilities.RpnToJexlConverter=Backshift.Class.create({initialize:function(){this.operators={},this._buildOperators()},_buildOperators:function(){var simpleOp=function(op){return function(stack){var b=stack.pop(),a=stack.pop();return"("+a+" "+op+" "+b+")"}},ifOp=function(stack){var c=stack.pop(),b=stack.pop(),a=stack.pop();return"("+a+" != 0 ? "+b+" : "+c+")"},unOp=function(stack){var a=stack.pop();return"( ("+a+" == __inf) || ("+a+" == __neg_inf) ? 1 : 0)"},booleanOp=function(op){return function(stack){var b=stack.pop(),a=stack.pop();return"("+a+" "+op+" "+b+" ? 1 : 0)"}};this.operators["+"]=simpleOp("+"),this.operators["-"]=simpleOp("-"),this.operators["*"]=simpleOp("*"),this.operators["/"]=simpleOp("/"),this.operators["%"]=simpleOp("%"),this.operators.IF=ifOp,this.operators.UN=unOp,this.operators.LT=booleanOp("<"),this.operators.LE=booleanOp("<="),this.operators.GT=booleanOp(">"),this.operators.GE=booleanOp(">="),this.operators.EQ=booleanOp("=="),this.operators.NE=booleanOp("!=")},convert:function(rpn){var token,tokens,n,i,stack=[];for(tokens=rpn.split(","),n=tokens.length,i=0;n>i;i++)token=tokens[i],this._isOperator(token)?stack.push(this._toExpression(token,stack)):stack.push(token);return 1===stack.length?stack.pop():void Backshift.fail("Too many input values in RPN express. RPN: "+rpn+" Stack: "+JSON.stringify(stack))},_isOperator:function(token){return token in this.operators},_toExpression:function(token,stack){return this.operators[token](stack)}}),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphVisitor=Backshift.Class.create({initialize:function(args){this.onInit(args)},onInit:function(args){},_visit:function(graphDef){var i,args,command,name,path,dsName,consolFun,rpnExpression,subParts,width,srcName,color,legend,CommandLineParser=function(){var parse=function(str,lookForQuotes){for(var args=[],readingPart=!1,part="",n=str.length,i=0;n>i;i++)" "!==str.charAt(i)||readingPart?'"'===str.charAt(i)&&lookForQuotes?(readingPart=!readingPart,part+=str.charAt(i)):part+=str.charAt(i):(args.push(part),part="");return args.push(part),args};return{parse:parse}}(),parts=CommandLineParser.parse(graphDef.command,!0),n=parts.length;for(i=0;n>i;i++){if(0===parts[i].indexOf("--")){if(args=/--(.*)=(.*)/.exec(parts[i]),null===args)continue;"title"===args[1]?this._onTitle(this._displayString(args[2])):"vertical-label"===args[1]&&this._onVerticalLabel(this._displayString(args[2]))}args=parts[i].split(":"),command=args[0],"DEF"===command?(subParts=args[1].split("="),name=subParts[0],path=subParts[1],dsName=args[2],consolFun=args[3],this._onDEF(name,path,dsName,consolFun)):"CDEF"===command?(subParts=args[1].split("="),name=subParts[0],rpnExpression=subParts[1],this._onCDEF(name,rpnExpression)):command.match(/LINE/)?(width=parseInt(/LINE(\d+)/.exec(command)),subParts=args[1].split("#"),srcName=subParts[0],color="#"+subParts[1],legend=this._displayString(args[2]),this._onLine(srcName,color,legend,width)):"AREA"===command?(subParts=args[1].split("#"),srcName=subParts[0],color="#"+subParts[1],legend=this._displayString(args[2]),this._onArea(srcName,color,legend)):"STACK"===command&&(subParts=args[1].split("#"),srcName=subParts[0],color="#"+subParts[1],legend=this._displayString(args[2]),this._onStack(srcName,color,legend))}},_onTitle:function(title){},_onVerticalLabel:function(label){},_onDEF:function(name,path,dsName,consolFun){},_onCDEF:function(name,rpnExpression){},_onLine:function(srcName,color,legend,width){},_onArea:function(srcName,color,legend){},_onStack:function(srcName,color,legend){},_displayString:function(string){return void 0===string?string:(string=string.replace(/"/g,""),string=string.replace("\\n",""),string=string.replace(/(.*)(\\)/,"$1"),string=string.trim())}}),Backshift.namespace("Backshift.Utilities.RrdGraphConverter"),Backshift.Utilities.RrdGraphConverter=Backshift.Class.create(Backshift.Utilities.RrdGraphVisitor,{onInit:function(args){this.graphDef=args.graphDef,this.resourceId=args.resourceId,this.model={metrics:[],series:[]},this.rpnConverter=new Backshift.Utilities.RpnToJexlConverter;var propertyValue,i,n=this.graphDef.propertiesValues.length;for(i=0;n>i;i++){propertyValue=this.graphDef.propertiesValues[i];var re=new RegExp("\\{"+propertyValue+"}","g");this.graphDef.command=this.graphDef.command.replace(re,propertyValue)}this._visit(this.graphDef);var nonTransientMetrics={};for(n=this.model.series.length,i=0;n>i;i++)nonTransientMetrics[this.model.series[i].metric]=1;var metric;for(n=this.model.metrics.length,i=0;n>i;i++)metric=this.model.metrics[i],metric["transient"]=!(metric.name in nonTransientMetrics)},_onTitle:function(title){this.model.title=title},_onVerticalLabel:function(label){this.model.verticalLabel=label},_onDEF:function(name,path,dsName,consolFun){var columnIndex=parseInt(/\{rrd(\d+)}/.exec(path)[1])-1,attribute=this.graphDef.columns[columnIndex];this.model.metrics.push({name:name,resourceId:this.resourceId,attribute:attribute,aggregation:consolFun})},_onCDEF:function(name,rpnExpression){this.model.metrics.push({name:name,expression:this.rpnConverter.convert(rpnExpression)})},_onLine:function(srcName,color,legend,width){this.model.series.push({name:legend,metric:srcName,type:"line",color:color})},_onArea:function(srcName,color,legend){this.model.series.push({name:legend,metric:srcName,type:"area",color:color})},_onStack:function(srcName,color,legend){this.model.series.push({name:legend,metric:srcName,type:"stack",color:color})}}),Backshift.namespace("Backshift.Graph"),Backshift.Graph=Backshift.Class.create(Backshift.Class.Configurable,{initialize:function(args){void 0===args.dataSource&&Backshift.fail("Graph needs a data source."),this.dataSource=args.dataSource,void 0===args.element&&Backshift.fail("Graph needs an element."),this.element=args.element,this.series=args.series,this.configure(args),0===this.start&&0===this.end&&0===this.last&&Backshift.fail("Graph needs start and end, or last to be non-zero."),this.queryInProgress=!1,this.lastSuccessfulQuery=0,this.timer=null,this.onInit(args)},defaults:function(){return{width:400,height:240,resolution:0,start:0,end:0,last:0,refreshRate:0,checkInterval:15e3}},render:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null),this.onRender(),this.refresh(),this.createTimer()},createTimer:function(){var self=this;this.timer=setInterval(function(){self.shouldRefresh()&&self.refresh()},this.checkInterval)},setStart:function(start){this.start=start,this.refresh()},setEnd:function(end){this.end=end,this.refresh()},refresh:function(){var self=this,timeSpan=this.getTimeSpan();this.queryInProgress=!0,this.onBeforeQuery(),this.dataSource.query(timeSpan.start,timeSpan.end,this.getResolution()).then(function(results){self.queryInProgress=!1,self.lastSuccessfulQuery=Date.now(),self.onQuerySuccess(results),self.onAfterQuery()},function(reason){self.queryInProgress=!1,self.onQueryFailed(reason),self.onAfterQuery()})},shouldRefresh:function(){return this.queryInProgress?!1:0===this.refreshRate?!1:this.lastSuccessfulQuery<=Date.now()-this.refreshRate},getTimeSpan:function(){var timeSpan={};return this.last>0?(timeSpan.end=Date.now(),timeSpan.start=timeSpan.end-this.last):(timeSpan.end=this.end,timeSpan.start=this.start),timeSpan},getResolution:function(){return this.resolution>0?this.resolution:this.width},onInit:function(args){},onRender:function(){},onBeforeQuery:function(){},onQuerySuccess:function(results){},onQueryFailed:function(reason){console.log("Query failed with: "+reason)},onAfterQuery:function(){}}),Backshift.namespace("Backshift.Graph.Matrix"),Backshift.Graph.Matrix=Backshift.Class.create(Backshift.Graph,{onInit:function(){this.statusBlock=null},onBeforeQuery:function(){this.timeBeforeQuery=Date.now(),this.updateStatus("Querying...")},onQuerySuccess:function(results){this.drawMatrix(results);var timeAfterQuery=Date.now(),queryDuration=Number((timeAfterQuery-this.timeBeforeQuery)/1e3).toFixed(2);this.updateStatus("Successfully retrieved data in "+queryDuration+" seconds.")},onQueryFailed:function(){this.updateStatus("Query failed.")},updateStatus:function(status){this.statusBlock?this.statusBlock.text(status):this.statusBlock=d3.select(this.element).append("p").attr("align","right").text(status)},drawMatrix:function(results){var i,k,numRows=results.columns[0].length,numColumns=results.columnNames.length,rows=new Array(numRows);for(i=0;numRows>i;i++)for(rows[i]={},k=0;numColumns>k;k++)rows[i][results.columnNames[k]]=results.columns[k][i];var status="";this.statusBlock&&(status=this.statusBlock.text()),d3.select(this.element).selectAll("*").remove(),this.statusBlock=d3.select(this.element).append("p").attr("align","right").text(status),this.tabulate(this.element,rows,results.columnNames),d3.select(this.element).attr("data-results",JSON.stringify(results)),d3.select(this.element).attr("data-rendered-at",Date.now())},tabulate:function(element,data,columns){var table=d3.select(element).append("table").attr("style","font-size: 10px"),thead=table.append("thead"),tbody=table.append("tbody");thead.append("tr").selectAll("th").data(columns).enter().append("th").text(function(column){return column});var rows=tbody.selectAll("tr").data(data).enter().append("tr");return rows.selectAll("td").data(function(row){return columns.map(function(column){return{column:column,value:row[column]}})}).enter().append("td").attr("style","font-family: Courier; padding:0 15px 0 15px;").attr("align","center").html(function(d){return Number(d.value).toFixed(4)}),table}}),Backshift.namespace("Backshift.Graph.C3"),Backshift.Graph.C3=Backshift.Class.create(Backshift.Graph,{defaults:function($super){return Backshift.extend($super(),{width:void 0,height:void 0,title:void 0,verticalLabel:void 0,clipboardData:void 0,exportIconSizeRatio:.03,step:!1})},onInit:function(){this.columns=[],this.groups=[],this.colorMap={},this.typeMap={},this.nameMap={},this.chartMessage="Loading...",this.clipboardPrimed=!1,this.exportIconSizeRatio>0&&document.addEventListener("copy",this._onClipboardCopy)},onRender:function(){this._updatePlot()},_shouldStack:function(k){if("area"===this.series[k].type)for(var n=this.series.length,i=k;n>i;i++)if("stack"===this.series[i].type)return 1;return"stack"===this.series[k].type},_getDisplayName:function(name){return void 0===name||null===name?null:name},_getType:function(type,shouldStack){var derivedType;return derivedType=shouldStack===!0?"area":type,this.step&&("line"===derivedType?derivedType="step":"area"===derivedType&&(derivedType="area-step")),derivedType},onQuerySuccess:function(results){var series,values,i,j,numSeries,numValues,X,Y,columnName,shouldStack,timestamps=results.columns[0];for(numSeries=this.series.length,numValues=timestamps.length,this.columns=[],X=["timestamp"],i=0;numValues>i;i++)X.push(timestamps[i]);this.columns[0]=X;var group=[];for(this.groups=[group],i=0;numSeries>i;i++){for(columnName="data"+i,series=this.series[i],values=results.columns[results.columnNameToIndex[series.metric]],Y=[columnName],j=0;numValues>j;j++)Y.push(values[j]);this.columns[i+1]=Y,this.colorMap[columnName]=series.color,this.nameMap[columnName]=this._getDisplayName(series.name),shouldStack=this._shouldStack(i),shouldStack&&group.push(columnName),this.typeMap[columnName]=this._getType(series.type,shouldStack)}this.chartMessage=null,this._updatePlot()},onQueryFailed:function($super,reason){$super(reason),this.chartMessage="Query failed."},_onToggleCsvExport:function(el){var iconColor="black";if(this.clipboardPrimed)window.backshift_c3_clipboard=void 0,this.clipboardPrimed=!1;else{iconColor="green";var i,j,csv="",numColumns=this.columns.length,numRows=numColumns>0?this.columns[0].length-1:0;for(i=0;numColumns>i;i++)0==i?csv="Timestamp":csv+=","+this.nameMap[this.columns[i][0]];for(i=1;numRows>=i;i++)for(csv+="\n",j=0;numColumns>j;j++)j>0&&(csv+=","),csv+=this.columns[j][i];window.backshift_c3_clipboard=csv,this.clipboardPrimed=!0}d3.select(el).style("fill",iconColor)},_onClipboardCopy:function(e){if(void 0!==window.backshift_c3_clipboard){var isIe=-1!=navigator.userAgent.toLowerCase().indexOf("msie")||-1!=navigator.userAgent.toLowerCase().indexOf("trident");isIe?window.clipboardData.setData("Text",window.backshift_c3_clipboard):e.clipboardData.setData("text/plain",window.backshift_c3_clipboard),e.preventDefault()}},_onRendered:function(){var self=this,svg=d3.select(this.element).select("svg"),boundingRect=svg.node().getBoundingClientRect();if(svg.select("#chart-title").remove(),null!==this.chartMessage&&svg.append("text").attr("id","chart-title").attr("x",boundingRect.width/2).attr("y",boundingRect.height/2.5).attr("text-anchor","middle").style("font-size","2.5em").text(this.chartMessage),svg.select("#export-to-csv").remove(),this.columns.length>0&&this.exportIconSizeRatio>0){var sizeInPixels=boundingRect.width*this.exportIconSizeRatio;svg.append("text").attr("id","export-to-csv").attr("x",boundingRect.width-sizeInPixels).attr("y",sizeInPixels).attr("font-family","FontAwesome").attr("font-size",function(d){return sizeInPixels+"px"}).text(function(d){return""}).on("click",function(){return self._onToggleCsvExport(this,self)})}},_updatePlot:function(){var self=this;c3.generate({bindto:d3.select(this.element),data:{x:"timestamp",columns:this.columns,types:this.typeMap,names:this.nameMap,colors:this.colorMap,groups:this.groups,order:null},size:{width:this.width,height:this.height},axis:{x:{type:"timeseries",tick:{culling:{max:8}}},y:{label:this.verticalLabel,tick:{format:d3.format(".2s")}}},grid:{x:{show:!0},y:{show:!0}},transition:{duration:0},point:{show:!1},zoom:{enabled:!0},onrendered:function(){self._onRendered()},title:{text:this.title},tooltip:{format:{title:function(d){return d},value:function(value,ratio,id){return d3.format(".4s")(value)}}}})}});