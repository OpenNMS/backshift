<!DOCTYPE html>
<html>
<head lang="en">
    <link rel="stylesheet" type="text/css" href="../vendor/rickshaw.min.css">
    <script src="../vendor/d3.min.js"></script>
    <script src="../vendor/jquery.min.js"></script>
    <script src="../vendor/rickshaw.js"></script>
    <script src="../vendor/markup.min.js"></script>
    <script src="../src/Compat.js"></script>
    <script src="../src/Backshift.js"></script>
    <script src="../src/Backshift.Class.js"></script>
    <script src="../src/Backshift.Class.Configurable.js"></script>
    <script src="../src/Backshift.Math.js"></script>
    <script src="../src/Backshift.Stats.js"></script>
    <script src="../src/Backshift.Utilities.Url.js"></script>
    <script src="../src/Backshift.Utilities.RrdGraphConverter.js"></script>
    <script src="../src/Backshift.Data.js"></script>
    <script src="../src/Backshift.Data.Newts.js"></script>
    <script src="../src/Backshift.Data.Mock.js"></script>
    <script src="../src/Backshift.Data.Mock.TrigFnFactory.js"></script>
    <script src="../src/Backshift.Data.Mock.Trig.js"></script>
    <script src="../src/Backshift.Data.OnmsRRD.js"></script>
    <script src="../src/Backshift.Data.Factory.js"></script>
    <script src="../src/Backshift.Legend.js"></script>
    <script src="../src/Backshift.Legend.Rickshaw.js"></script>
    <script src="../src/Backshift.Graph.js"></script>
    <script src="../src/Backshift.Graph.Matrix.js"></script>
    <script src="../src/Backshift.Graph.Rickshaw.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <style>
        .row {
            margin-top: 25px;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2>Backshift vs RRD Graphs</h2>
    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.memStats" data-graph-resource="node[1].nodeSnmp[]" data-original-graph="rrd1"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd1"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.hrMemory" data-graph-resource="node[1].nodeSnmp[]" data-original-graph="rrd2" data-graph-model="graph2"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd2"></div>
        </div>
        <div class="col-md-4">
            <div id="graph2"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.hrSystemProcesses" data-graph-resource="node[1].nodeSnmp[]" data-original-graph="rrd3"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd3"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.loadavg" data-graph-resource="node[1].nodeSnmp[]" data-original-graph="rrd4"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd4"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.cpuUsageFull" data-graph-resource="node[1].nodeSnmp[]" data-original-graph="rrd5"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd5"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.cpuStatsFull" data-graph-resource="node[1].nodeSnmp[]" data-original-graph="rrd6"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd6"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="mib2.HCbits" data-graph-resource="node[1].interfaceSnmp[eth0-0800279114ca]" data-original-graph="rrd7" data-graph-model="graph7"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd7"></div>
        </div>
        <div class="col-md-4">
            <div id="graph7"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="mib2.HCtraffic-inout" data-graph-resource="node[1].interfaceSnmp[eth0-0800279114ca]" data-original-graph="rrd8"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd8"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="onms.collectd.threadpool" data-graph-resource="node[1].interfaceSnmp[opennms-jvm]" data-original-graph="rrd9" data-graph-model="graph9"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd9"></div>
        </div>
        <div class="col-md-4">
            <div id="graph9"></div>
        </div>
    </div>


    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="jvm.mempool.eden" data-graph-resource="node[1].interfaceSnmp[opennms-jvm]" data-original-graph="rrd10"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd10"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="icmp" data-graph-resource="node[1].responseTime[127.0.0.1]" data-original-graph="rrd11"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd11"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="ssh" data-graph-resource="node[1].responseTime[127.0.0.1]" data-original-graph="rrd12"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd12"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var onmsHost = "127.0.0.1",
        onmsPort = 8980,
        onmsUsername = 'admin',
        onmsPassword = 'admin';

    function getBaseHref() {
        return "http://" + onmsHost + ":" + onmsPort;
    }

    var rrdGraphConverter = new Backshift.Utilities.RrdGraphConverter();

    $( document ).ready(function() {
        $("div[data-graph-report]").each(function() {
            var report = $(this).data('graph-report');
            var resource = $(this).data('graph-resource');
            var start = $(this).data('graph-start');
            var end = $(this).data('graph-end');

            var url = getBaseHref() + '/opennms/rest/graphs/' + encodeURIComponent(report);
            console.log('Requesting graph definition from ' + url);

            $.ajax({
                url: url,
                username: onmsUsername,
                password: onmsPassword,
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                context: $(this)
            }).done(function(graph) {
                console.log("Graph: ", JSON.stringify(graph, null, 2));

                var model = rrdGraphConverter.convert(graph);

                // Point to the REST service
                model.dataProcessor = {};
                model.dataProcessor.type = 'onmsrrd';
                model.dataProcessor.url = getBaseHref() + "/opennms/rest/measurements";
                model.dataProcessor.username = onmsUsername;
                model.dataProcessor.password = onmsPassword;

                // Use the default legend
                //graph.model.legend =  "{{series}}{{ if name|more>1 }}{{swatch}}{{name}} Avg: {{avg|fix>2}} Min: {{min|fix>2}} Max: {{max|fix>2}}<br/>{{/if}}{{/series}}";

                // Enable the preview pane
                //graph.model.preview = true;

                // Render the graph
                var bsGraph = new Backshift.Graph.Rickshaw({
                    model: model,
                    element: $(this)[0],
                    width: 600,
                    height: 400,
                    start: Math.floor(Number(graph.start) / 1000),
                    end: Math.floor(Number(graph.end) / 1000)
                });
                bsGraph.render();

                $(this).append();

                // Pull in the RRD graph for comparison
                var rrdGraphImageUrl = "http://" + onmsHost + ":" + onmsPort + "/opennms/graph/graph.png?resourceId=" + resource +
                        "&report=" + encodeURIComponent(report) +
                        "&start=" + graph.start +
                        "&end=" + graph.end +
                        "&width=480&height=320";
                $('#'+ $(this).data('original-graph')).prepend('<img src="' + rrdGraphImageUrl + '" />');

                $('#'+ $(this).data('graph-model')).prepend("<pre>" + JSON.stringify(graph, null, 2) + "</pre>");
            });
        });
    });
</script>
</body>
</html>