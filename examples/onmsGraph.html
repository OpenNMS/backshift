<!DOCTYPE html>
<html>
<head lang="en">
    <!-- Backshift + C3 deps -->
    <script src="../vendor/d3.min.js"></script>
    <script src="../vendor/c3.js"></script>

    <script src="../src/Compat.js"></script>
    <script src="../src/Backshift.js"></script>
    <script src="../src/Backshift.Class.js"></script>
    <script src="../src/Backshift.Class.Configurable.js"></script>
    <script src="../src/Backshift.Math.js"></script>
    <script src="../src/Backshift.Stats.js"></script>
    <script src="../src/Backshift.Utilities.Url.js"></script>
    <script src="../src/Backshift.Utilities.RpnToJexlConverter.js"></script>
    <script src="../src/Backshift.Utilities.RrdGraphVisitor.js"></script>
    <script src="../src/Backshift.Utilities.RrdGraphConverter.js"></script>
    <script src="../src/Backshift.Data.js"></script>
    <script src="../src/Backshift.Data.OnmsRRD.js"></script>
    <script src="../src/Backshift.Data.Factory.js"></script>
    <script src="../src/Backshift.Graph.js"></script>
    <script src="../src/Backshift.Graph.C3.js"></script>

    <link rel="stylesheet" href="../vendor/c3.css">

    <!-- For this page -->
    <script src="../vendor/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <style>
        .row {
            margin-top: 25px;
        }
        .c3-area {
            stroke-width: 0;
            opacity: 1.0;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2>Backshift vs RRD Graphs</h2>
    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.memStats" data-graph-resource="node[3].nodeSnmp[]" data-original-graph="rrd1" data-graph-model="graph1"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd1"></div>
        </div>
        <div class="col-md-4">
            <div id="graph1"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.hrMemory" data-graph-resource="node[3].nodeSnmp[]" data-original-graph="rrd2" data-graph-model="graph2"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd2"></div>
        </div>
        <div class="col-md-4">
            <div id="graph2"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.hrSystemProcesses" data-graph-resource="node[3].nodeSnmp[]" data-original-graph="rrd3"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd3"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.loadavg" data-graph-resource="node[3].nodeSnmp[]" data-original-graph="rrd4"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd4"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.cpuUsageFull" data-graph-resource="node[3].nodeSnmp[]" data-original-graph="rrd5"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd5"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="netsnmp.cpuStatsFull" data-graph-resource="node[3].nodeSnmp[]" data-original-graph="rrd6"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd6"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div data-graph-report="icmp" data-graph-resource="node[3].responseTime[127.0.0.1]" data-original-graph="rrd11"></div>
        </div>
        <div class="col-md-4">
            <div id="rrd11"></div>
        </div>
    </div>

</div>

<script type="text/javascript">
    var onmsHost = "127.0.0.1",
        onmsPort = 8980,
        onmsUsername = 'admin',
        onmsPassword = 'admin',
        end = Date.now(),
        start = end - (4 * 60 * 60 * 1000);

    function getBaseHref() {
        return "http://" + onmsHost + ":" + onmsPort;
    }

    $( document ).ready(function() {
        $("div[data-graph-report]").each(function() {
            var report = $(this).data('graph-report');
            var resource = $(this).data('graph-resource');

            var url = getBaseHref() + '/opennms/rest/graphs/' + encodeURIComponent(report);
            console.log('Requesting graph definition from ' + url);

            // Pull in the graph definition
            $.ajax({
                url: url,
                username: onmsUsername,
                password: onmsPassword,
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                context: $(this)
            }).done(function(graphDef) {
                // Convert the graph definition to a Backshift model
                var rrdGraphConverter = new Backshift.Utilities.RrdGraphConverter({
                    graphDef: graphDef,
                    resourceId: resource
                });
                var model = rrdGraphConverter.model;

                // Update the model to use OpenNMS' ReST Measurements API
                model.dataProcessor = {};
                model.dataProcessor.type = 'onmsrrd';
                model.dataProcessor.url = getBaseHref() + "/opennms/rest/measurements";
                model.dataProcessor.username = onmsUsername;
                model.dataProcessor.password = onmsPassword;

                // Render the graph
                var bsGraph = new Backshift.Graph.C3({
                    model: model,
                    element: $(this)[0],
                    start: Math.floor(Number(start) / 1000),
                    end: Math.floor(Number(end) / 1000),
                    refreshRate: 0
                });
                bsGraph.render();

                // Pull in the RRD graph for comparison
                var rrdGraphImageUrl = "http://" + onmsHost + ":" + onmsPort + "/opennms/graph/graph.png?resourceId=" + resource +
                        "&report=" + encodeURIComponent(report) +
                        "&start=" + start +
                        "&end=" + end +
                        "&width=480&height=320";
                $('#'+ $(this).data('original-graph')).prepend('<img src="' + rrdGraphImageUrl + '" />');

                // Show the resulting model if the div is defined
                $('#'+ $(this).data('graph-model')).prepend("<pre>" + JSON.stringify(model, null, 2) + "</pre>");
            });
        });
    });
</script>
</body>
</html>